<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/pro.css}">
</head>
<body>
    <div th:replace="fragments/navbar :: navbarFragment"></div>
    <div class="layout">
        <aside>
            <h3>Teacher Menu</h3>
            <button onclick="showSection('overview')">Dashboard Overview</button>
            <button onclick="showSection('courses')">Courses</button>
            <button onclick="showSection('grades')">Grade Entry</button>
            <button onclick="showSection('attendance')">Attendance</button>
            <button onclick="logout()">Logout</button>
        </aside>
        <main>
            <section id="overview" class="active">
                <h2 style="margin-bottom: 1.5rem; font-size: 2rem; font-weight: 700; letter-spacing: 1px;">Dashboard Overview</h2>
                <div class="overview-cards" style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2.5rem;">
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #4299e1; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Total Students</div>
                            <div id="totalStudents" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #48bb78; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-book"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Total Courses</div>
                            <div id="totalCourses" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #f6ad55; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Average Grade</div>
                            <div id="averageGrade" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                </div>
                <div class="extra-analytics" style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2.5rem;">
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 1.5rem 1.2rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #805ad5; color: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div>
                            <div style="font-size: 1rem; color: #718096;">Top GPA</div>
                            <div id="topGpa" style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 1.5rem 1.2rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #e53e3e; color: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <div style="font-size: 1rem; color: #718096;">Pass Rate</div>
                            <div id="passRate" style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                </div>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
                <script>
                function loadDashboardOverview() {
                    fetch('/api/dashboard/overview')
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('totalStudents').textContent = data.totalStudents;
                            document.getElementById('totalCourses').textContent = data.totalCourses;
                            document.getElementById('averageGrade').textContent = data.averageGradePercent.toFixed(2) + '%';
                            if (data.topGpa !== undefined) document.getElementById('topGpa').textContent = data.topGpa.toFixed(2);
                            if (data.passRate !== undefined) document.getElementById('passRate').textContent = data.passRate.toFixed(1) + '%';
                        });
                }
                document.addEventListener('DOMContentLoaded', function() {
                    loadDashboardOverview();
                    if (typeof loadGpaTable === 'function') loadGpaTable();
                });
                </script>

                <!-- GPA per course section -->
                <div class="gpa-table-container" style="margin-top:2.5rem">
                    <h3>Course GPA Report</h3>
                    <label for="gpaCourseSelect">Select Course:</label>
                    <select id="gpaCourseSelect" style="margin-bottom: 1rem; min-width: 220px;">
                        <option value="">-- Select a course --</option>
                        <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                    </select>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>GPA</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody id="courseGpaTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <script>
                document.getElementById('gpaCourseSelect').addEventListener('change', function() {
                    const courseId = this.value;
                    const tbody = document.getElementById('courseGpaTableBody');
                    tbody.innerHTML = '';
                    if (!courseId) return;
                    fetch(`/api/courses/${courseId}/gpa`)
                        .then(res => res.json())
                        .then(data => {
                            data.forEach(row => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${row.studentId}</td>
                                    <td>${row.name}</td>
                                    <td>${row.gpa.toFixed(2)}</td>
                                    <td>${row.percentage.toFixed(2)}%</td>
                                    <td><span style="color: #fff; background:${row.color}; padding: 4px 12px; border-radius: 12px; font-weight:600;">${row.gradeCategory}</span></td>
                                `;
                                tbody.appendChild(tr);
                            });
                        });
                });
                </script>
            </section>

            <section id="courses">
                <h2>Your courses</h2>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Teacher</th>
                            <th>Enrolled</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
<!--                        <tr>-->
<!--                            <td>101</td>-->
<!--                            <td><a class="view-link" href="#">Introduction to Java</a></td>-->
<!--                            <td>Basic Java programming concepts</td>-->
<!--                            <td>John Smith</td>-->
<!--                            <td>25</td>-->
<!--                            <td><a class="edit-link" href="#">Edit</a></td>-->
<!--                        </tr>-->
                        <tr th:each="course : ${courses}">
                            <td th:text="${course.id}"></td>
                            <td>
                                <a class="view-link" th:href="@{/courses/{id}/students(id=${course.id})}"
                                   th:text="${course.name}"></a>
                            </td>
                            <td th:text="${course.description}"></td>
                            <td th:text="${course.teacher.firstName + ' ' + course.teacher.lastName}"></td>
                            <td><!-- يمكنك تفعيل هذا السطر إذا كان لديك enrolledStudents --></td>
                            <td>
                                <a class="edit-link" th:href="@{/courses/{id}/edit(id=${course.id})}">Edit</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="grades">
                <h2>Grade Entry</h2>
                <div class="grade-entry-container">
                    <div class="course-selector">
                        <label for="gradeCourseSelect">Select Course:</label>
                        <select id="gradeCourseSelect" onchange="loadStudentsForGrading()">
                            <option value="">-- Select a course --</option>
                            <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                        </select>
                    </div>
                    
                    <div id="gradeForm" style="margin-top: 2rem; display: none;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Midterm</th>
                                        <th>Final Exam</th>
                                        <th>Assignments</th>
                                        <th>Quizzes</th>
                                        <th>Project</th>
                                        <th>Attendance</th>
                                        <th>Finished</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="gradeTableBody">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="form-actions" style="margin-top: 1rem;">
                            <button onclick="saveAllGrades()" class="primary">Save All Grades</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="attendance">
                <h2>Attendance Entry</h2>
                <label for="attendanceCourseSelect">Select Course:</label>
                <select id="attendanceCourseSelect" onchange="loadAttendanceStudents()">
                    <option value="">-- Select a course --</option>
                    <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                </select>
                <form id="attendanceForm" style="display:none" onsubmit="return saveAttendance(event)">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th>Date</th>
                                    <th>Status (Absent)</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="primary">Save</button>
                </form>
            </section>
        </main>
    </div>
    <script>
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function displayCourseStudents() {
            const select = document.getElementById('courseSelect');
            document.getElementById('courseStudents').style.display = select.value === "" ? 'none' : 'block';
        }
        function displayGradeForm() {
            const select = document.getElementById('gradeCourseSelect');
            document.getElementById('gradeForm').style.display = select.value === "" ? 'none' : 'block';
        }
        function logout() {
            window.location.href = "http://localhost:8080/logout";
        }
    </script>

    <script>
        function toggleStatusColor(checkbox) {
            if (checkbox.checked) {
                checkbox.classList.remove('red');
            } else {
                checkbox.classList.add('red');
            }
        }
    </script>

    <script>
    function loadAttendanceStudents() {
        const courseId = document.getElementById('attendanceCourseSelect').value;
        const form = document.getElementById('attendanceForm');
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';
        if (!courseId) {
            form.style.display = 'none';
            return;
        }
        fetch(`/api/courses/${courseId}/students`)
            .then(res => res.json())
            .then(data => {
                const today = new Date().toISOString().slice(0, 10);
                data.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${today}</td>
                        <td><input type="checkbox" name="absent" value="${student.id}"></td>
                    `;
                    tbody.appendChild(row);
                });
                form.style.display = '';
            });
    }

    function saveAttendance(event) {
        event.preventDefault();
        const courseId = document.getElementById('attendanceCourseSelect').value;
        const absentIds = Array.from(document.querySelectorAll('input[name="absent"]:checked')).map(cb => cb.value);
        fetch(`/api/courses/${courseId}/attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(absentIds)
        }).then(res => {
            if (res.ok) {
                showNotification('Attendance saved!', 'success');
                loadAttendanceStudents();
            } else {
                showNotification('Error saving attendance', 'error');
            }
        });
        return false;
    }
    </script>

    <script>
    function loadStudentsForGrading() {
        const courseId = document.getElementById('gradeCourseSelect').value;
        const form = document.getElementById('gradeForm');
        const tbody = document.getElementById('gradeTableBody');
        tbody.innerHTML = '';
        
        if (!courseId) {
            form.style.display = 'none';
            return;
        }

        fetch(`/api/courses/${courseId}/students-for-grading`)
            .then(res => res.json())
            .then(data => {
                data.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.studentId}</td>
                        <td>${student.name}</td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.midterm || ''}" 
                            onchange="updateGrade(${student.studentId}, 'midterm', this.value)"></td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.finalExam || ''}" 
                            onchange="updateGrade(${student.studentId}, 'finalExam', this.value)"></td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.assignments || ''}" 
                            onchange="updateGrade(${student.studentId}, 'assignments', this.value)"></td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.quizzes || ''}" 
                            onchange="updateGrade(${student.studentId}, 'quizzes', this.value)"></td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.project || ''}" 
                            onchange="updateGrade(${student.studentId}, 'project', this.value)"></td>
                        <td><input type="number" min="0" max="100" step="0.1" 
                            value="${student.attendance || ''}" 
                            onchange="updateGrade(${student.studentId}, 'attendance', this.value)"></td>
                        <td><input type="checkbox" 
                            ${student.finished ? 'checked' : ''} 
                            onchange="updateGrade(${student.studentId}, 'finished', this.checked)"></td>
                        <td>
                            <button onclick="saveStudentGrade(${student.studentId})" class="secondary">Save</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                form.style.display = '';
            });
    }

    let pendingGrades = new Map();

    function updateGrade(studentId, field, value) {
        if (!pendingGrades.has(studentId)) {
            pendingGrades.set(studentId, {});
        }
        // Convert string values to appropriate types
        if (field === 'finished') {
            pendingGrades.get(studentId)[field] = value;
        } else {
            // Convert to number, use 0 if empty or invalid
            const numValue = value === '' ? 0 : parseFloat(value);
            pendingGrades.get(studentId)[field] = isNaN(numValue) ? 0 : numValue;
        }
    }

    function saveAllGrades() {
        const courseId = document.getElementById('gradeCourseSelect').value;
        if (pendingGrades.size === 0) {
            showNotification('No changes to save');
            return;
        }

        // Convert Map to array of objects with proper structure
        const gradesData = Array.from(pendingGrades.entries()).map(([studentId, grades]) => ({
            studentId: parseInt(studentId),
            grades: Object.fromEntries(
                Object.entries(grades).map(([key, value]) => [
                    key,
                    key === 'finished' ? value : parseFloat(value)
                ])
            )
        }));

        fetch(`/api/courses/${courseId}/grades`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(gradesData)
        })
        .then(res => {
            if (res.ok) {
                pendingGrades.clear();
                showNotification('All grades saved successfully!', 'success');
                loadStudentsForGrading();
            } else {
                res.text().then(text => {
                    showNotification('Error saving grades: ' + text, 'error');
                });
            }
        })
        .catch(error => {
            showNotification('Error saving grades: ' + error.message, 'error');
        });
    }

    function saveStudentGrade(studentId) {
        const courseId = document.getElementById('gradeCourseSelect').value;
        const grades = pendingGrades.get(studentId);
        if (!grades) return;

        // Convert grades to proper numeric values
        const processedGrades = Object.fromEntries(
            Object.entries(grades).map(([key, value]) => [
                key,
                key === 'finished' ? value : parseFloat(value)
            ])
        );

        fetch(`/api/courses/${courseId}/grades/${studentId}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(processedGrades)
        })
        .then(res => {
            if (res.ok) {
                pendingGrades.delete(studentId);
                showNotification('Grades saved successfully!', 'success');
                loadStudentsForGrading();
            } else {
                res.text().then(text => {
                    showNotification('Error saving grades: ' + text, 'error');
                });
            }
        })
        .catch(error => {
            showNotification('Error saving grades: ' + error.message, 'error');
        });
    }
    </script>

    <!-- Notification container -->
    <div id="notification" style="position:fixed;top:32px;right:32px;z-index:9999;min-width:260px;max-width:350px;display:none;"></div>

    <script>
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.innerHTML = `<div class="notify-box ${type}">${message}</div>`;
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
    </script>
    <style>
    .notify-box {
        background: #fff;
        color: #222;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.13);
        padding: 1.1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 8px;
        border-left: 6px solid #38a169;
        opacity: 0;
        animation: fadeInOut 3s forwards;
        position: relative;
    }
    .notify-box.success { border-color: #38a169; }
    .notify-box.error { border-color: #e53e3e; }
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-20px); }
        10% { opacity: 1; transform: translateY(0); }
        90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    </style>

</body>
</html>
