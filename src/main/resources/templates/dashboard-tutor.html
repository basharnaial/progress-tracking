<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/pro.css}">
</head>
<body>
    <div th:replace="fragments/navbar :: navbarFragment"></div>
    <div class="layout">
        <aside>
            <h3>Teacher Menu</h3>
            <button onclick="showSection('overview')">Dashboard Overview</button>
            <button onclick="showSection('courses')">Courses</button>
            <button onclick="showSection('grades')">Grade Entry</button>
            <button onclick="showSection('attendance')">Attendance</button>
            <button onclick="logout()">Logout</button>
        </aside>
        <main>
            <section id="overview" class="active">
                <h2 style="margin-bottom: 1.5rem; font-size: 2rem; font-weight: 700; letter-spacing: 1px;">Dashboard Overview</h2>
                <div class="overview-cards" style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2.5rem;">
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #4299e1; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Total Students</div>
                            <div id="totalStudents" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #48bb78; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-book"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Total Courses</div>
                            <div id="totalCourses" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 2rem 1.5rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #f6ad55; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <div style="font-size: 1.1rem; color: #718096;">Average Grade</div>
                            <div id="averageGrade" style="font-size: 2rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                </div>
                <div class="extra-analytics" style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2.5rem;">
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 1.5rem 1.2rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #805ad5; color: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div>
                            <div style="font-size: 1rem; color: #718096;">Top GPA</div>
                            <div id="topGpa" style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                    <div class="overview-card" style="flex:1; min-width: 220px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(66,153,225,0.08); padding: 1.5rem 1.2rem; display: flex; align-items: center; gap: 1.2rem;">
                        <div style="background: #e53e3e; color: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <div style="font-size: 1rem; color: #718096;">Pass Rate</div>
                            <div id="passRate" style="font-size: 1.3rem; font-weight: bold; color: #2d3748;">...</div>
                        </div>
                    </div>
                </div>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
                <script>
                function loadDashboardOverview() {
                    fetch('/api/dashboard/overview')
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('totalStudents').textContent = data.totalStudents;
                            document.getElementById('totalCourses').textContent = data.totalCourses;
                            document.getElementById('averageGrade').textContent = data.averageGradePercent.toFixed(2) + '%';
                            if (data.topGpa !== undefined) document.getElementById('topGpa').textContent = data.topGpa.toFixed(2);
                            if (data.passRate !== undefined) document.getElementById('passRate').textContent = data.passRate.toFixed(1) + '%';
                        });
                }
                document.addEventListener('DOMContentLoaded', function() {
                    loadDashboardOverview();
                    if (typeof loadGpaTable === 'function') loadGpaTable();
                });
                </script>

                <!-- GPA per course section -->
                <div class="gpa-table-container" style="margin-top:2.5rem">
                    <h3>Course GPA Report</h3>
                    <label for="gpaCourseSelect">Select Course:</label>
                    <select id="gpaCourseSelect" style="margin-bottom: 1rem; min-width: 220px;">
                        <option value="">-- Select a course --</option>
                        <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                    </select>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>GPA</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody id="courseGpaTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <script>
                document.getElementById('gpaCourseSelect').addEventListener('change', function() {
                    const courseId = this.value;
                    const tbody = document.getElementById('courseGpaTableBody');
                    tbody.innerHTML = '';
                    if (!courseId) return;
                    fetch(`/api/courses/${courseId}/gpa`)
                        .then(res => res.json())
                        .then(data => {
                            data.forEach(row => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${row.studentId}</td>
                                    <td>${row.name}</td>
                                    <td>${row.gpa.toFixed(2)}</td>
                                    <td>${row.percentage.toFixed(2)}%</td>
                                    <td><span style="color: #fff; background:${row.color}; padding: 4px 12px; border-radius: 12px; font-weight:600;">${row.gradeCategory}</span></td>
                                `;
                                tbody.appendChild(tr);
                            });
                        });
                });
                </script>
            </section>

            <section id="courses">
                <h2>Your courses</h2>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Teacher</th>
                            <th>Enrolled</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
<!--                        <tr>-->
<!--                            <td>101</td>-->
<!--                            <td><a class="view-link" href="#">Introduction to Java</a></td>-->
<!--                            <td>Basic Java programming concepts</td>-->
<!--                            <td>John Smith</td>-->
<!--                            <td>25</td>-->
<!--                            <td><a class="edit-link" href="#">Edit</a></td>-->
<!--                        </tr>-->
                        <tr th:each="course : ${courses}">
                            <td th:text="${course.id}"></td>
                            <td>
                                <a class="view-link" th:href="@{/courses/{id}/students(id=${course.id})}"
                                   th:text="${course.name}"></a>
                            </td>
                            <td th:text="${course.description}"></td>
                            <td th:text="${course.teacher.firstName + ' ' + course.teacher.lastName}"></td>
                            <td><!-- يمكنك تفعيل هذا السطر إذا كان لديك enrolledStudents --></td>
                            <td>
                                <a class="edit-link" th:href="@{/courses/{id}/edit(id=${course.id})}">Edit</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="grades">
                <h2>Grade Entry</h2>
                <select id="gradeCourseSelect" onchange="displayGradeForm()">
                    <option value="">-- Select a course --</option>
                    <option value="math">Math 101</option>
                    <option value="physics">Physics 202</option>
                </select>
                <div id="gradeForm" style="margin-top:1rem; display:none">
                    <table>
                        <tr>
                            <th>Student</th><th>Midterm</th><th>Final</th><th>Quizzes</th><th>Assignments</th><th>Project</th><th>Attendance</th><th>Finished</th>
                        </tr>
                        <tr>
                            <td>John Doe</td>
                            <td><input type="number"></td>
                            <td><input type="number"></td>
                            <td><input type="number"></td>
                            <td><input type="number"></td>
                            <td><input type="number"></td>
                            <td><input type="number"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                    </table>
                </div>
            </section>

            <section id="attendance">
                <h2>Attendance Entry</h2>
                <label for="attendanceCourseSelect">Select Course:</label>
                <select id="attendanceCourseSelect" onchange="loadAttendanceStudents()">
                    <option value="">-- Select a course --</option>
                    <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"></option>
                </select>
                <form id="attendanceForm" style="display:none" onsubmit="return saveAttendance(event)">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Student Name</th>
                                    <th>Date</th>
                                    <th>Status (Absent)</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="primary">Save</button>
                </form>
            </section>
        </main>
    </div>
    <script>
        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function displayCourseStudents() {
            const select = document.getElementById('courseSelect');
            document.getElementById('courseStudents').style.display = select.value === "" ? 'none' : 'block';
        }
        function displayGradeForm() {
            const select = document.getElementById('gradeCourseSelect');
            document.getElementById('gradeForm').style.display = select.value === "" ? 'none' : 'block';
        }
        function logout() {
            window.location.href = "http://localhost:8080/logout";
        }
    </script>

    <script>
        function toggleStatusColor(checkbox) {
            if (checkbox.checked) {
                checkbox.classList.remove('red');
            } else {
                checkbox.classList.add('red');
            }
        }
    </script>

    <script>
    function loadAttendanceStudents() {
        const courseId = document.getElementById('attendanceCourseSelect').value;
        const form = document.getElementById('attendanceForm');
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';
        if (!courseId) {
            form.style.display = 'none';
            return;
        }
        fetch(`/api/courses/${courseId}/students`)
            .then(res => res.json())
            .then(data => {
                const today = new Date().toISOString().slice(0, 10);
                data.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${today}</td>
                        <td><input type="checkbox" name="absent" value="${student.id}"></td>
                    `;
                    tbody.appendChild(row);
                });
                form.style.display = '';
            });
    }

    function saveAttendance(event) {
        event.preventDefault();
        const courseId = document.getElementById('attendanceCourseSelect').value;
        const absentIds = Array.from(document.querySelectorAll('input[name="absent"]:checked')).map(cb => cb.value);
        fetch(`/api/courses/${courseId}/attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(absentIds)
        }).then(res => {
            if (res.ok) {
                alert('Attendance saved!');
                loadAttendanceStudents();
            } else {
                alert('Error saving attendance');
            }
        });
        return false;
    }
    </script>

</body>
</html>
